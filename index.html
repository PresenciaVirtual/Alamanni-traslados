<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generación y Escaneo de QR</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script> <!-- Para generar QR -->
  <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.0.3/minified/html5-qrcode.min.js"></script> <!-- Para escanear QR -->
</head>
<body>
  <h1>Registro de Usuario</h1>
  <form id="userForm">
    <label for="name">Nombre:</label>
    <input type="text" id="name" required><br>
    <label for="email">Email:</label>
    <input type="email" id="email" required><br>
    <button type="submit">Generar QR</button>
  </form>

  <h2>Tu código QR</h2>
  <canvas id="qrcode"></canvas>

  <h2>Escanear QR</h2>
  <div id="reader" style="width:300px;"></div>
  <p id="userInfo"></p>

  <script>
    // Configurar Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      databaseURL: "https://alamanni-traslados.firebaseio.com/",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Obtener elementos del DOM
    const userForm = document.getElementById('userForm');
    const qrCodeCanvas = document.getElementById('qrcode');
    const userInfo = document.getElementById('userInfo');

    // Función para generar y guardar el QR del usuario
    userForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const userId = Date.now(); // Crear un ID único para cada usuario

      const userData = {
        name: name,
        email: email
      };

      // Guardar en la base de datos de Firebase
      database.ref('users/' + userId).set(userData)
        .then(() => {
          const qrData = `https://alamanni-traslados.firebaseapp.com/user/${userId}`; // Cambia esto a tu dominio
          QRCode.toCanvas(qrCodeCanvas, qrData, function (error) {
            if (error) console.error(error);
            console.log('Código QR generado!');
          });
        })
        .catch((error) => {
          console.error('Error guardando la información: ', error);
        });
    });

    // Escanear QR y obtener información del usuario
    function onScanSuccess(qrMessage) {
      const userId = qrMessage.split('/').pop();
      database.ref('users/' + userId).once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          if (data) {
            userInfo.innerText = `Nombre: ${data.name}, Email: ${data.email}`;
          } else {
            userInfo.innerText = 'Usuario no encontrado.';
          }
        })
        .catch((error) => {
          console.error('Error obteniendo los datos del usuario: ', error);
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, {
      fps: 10,
      qrbox: 250
    }, onScanSuccess)
    .catch((error) => {
      console.error('Error iniciando el escáner QR:', error);
    });
  </script>
</body>
</html>
